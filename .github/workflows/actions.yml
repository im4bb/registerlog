name: Actions CI
on:
  push:
    branches:
    - master
    - vm

jobs:
  check:
    name: Check
    if: (!contains(github.event.head_commit.message, '[ci skip]') && !contains(github.event.head_commit.message, '[skip ci]'))
    runs-on: ubuntu-latest
    env:
      PHP_VERSION: 7.1
      PHPBB_BRANCH: 3.3.x                     # phpBB Branch
      EXTNAME: borisba/registerlog            # CHANGE name of the extension HERE
      SNIFF: 1                                # Should we run code sniffer on your code?
      EPV: 1                                  # Should we run EPV (Extension Pre Validator) on your code?

    steps:
    - name: Actions Checkout
      uses: actions/checkout@v1

    - name: Actions Setup - Copy to Temp Location
      run: |
          mkdir --parents ../tmp
          cp -R . ../tmp

    - name: Actions Setup - Clone phpBB
      run: |
          git clone --depth=1 https://github.com/phpbb/phpbb.git phpBB3 --branch=$PHPBB_BRANCH

    - name: Setup PHP
      uses: shivammathur/setup-php@v2
      with:
        php-version: ${{ env.PHP_VERSION }}
        extensions: dom, curl, libxml, mbstring, zip, pcntl, pdo, mysqli, sqlite, pdo_sqlite, intl, gd, exif, iconv, sqlsrv, pdo_sqlsrv, ldap
        coverage: none

    - name: Actions Setup - Composer Install/Remove/Require
      run: |
          cd phpBB3/phpBB
          composer install --no-interaction --no-progress --no-suggest --ignore-platform-reqs
          composer remove sami/sami --no-interaction --no-progress --ignore-platform-reqs --dev
          # composer require phpbb/epv:dev-master --no-interaction --no-progress --no-suggest --ignore-platform-reqs --dev
    - name: Actions Setup - Copy from Temp Location
      run: |
          mkdir --parents phpBB3/phpBB/ext/$EXTNAME
          cp -R ../tmp/* phpBB3/phpBB/ext/$EXTNAME
    - name: Actions Test - Code Sniffer
      run: |
          cd phpBB3
          sh -c 'if [ "$SNIFF" != 0 ];
            then phpBB/vendor/bin/phpcs -s --extensions=php --standard=build/code_sniffer/ruleset-php-extensions.xml \
              "--ignore=*/$EXTNAME/tests/*" "--ignore=*/$EXTNAME/vendor/*" "phpBB/ext/$EXTNAME"; fi
          '

    - name: Setup EPV
      if: ${{ env.EPV != 0 }}
      run: composer require phpbb/epv:dev-master --dev --no-interaction --ignore-platform-reqs
      working-directory: phpBB3/phpBB

    - name: Actions Test - EPV (Extension Pre Validator)
      if: ${{ env.EPV != 0 }}
      working-directory: phpBB3
      run: phpBB/vendor/bin/EPV.php run --dir="phpBB/ext/$EXTNAME/"
