name: Actions CI
on:
  push:
    branches:
    - master
    - vm

jobs:
  check:
    name: Check
    runs-on: ubuntu-latest
    env:
      PHP_VERSION: 7.1
      PHPBB_BRANCH: 3.3.x                     # phpBB Branch
      EXTNAME: borisba/registerlog            # CHANGE name of the extension HERE
      SNIFF: 1                                # Should we run code sniffer on your code?
      EPV: 1                                  # Should we run EPV (Extension Pre Validator) on your code?

    steps:
    - name: Checkout phpBB
      uses: actions/checkout@v2
      with:
        repository: phpbb/phpbb
        ref: ${{ env.PHPBB_BRANCH }}
        path: phpBB3

    - name: Checkout extension
      uses: actions/checkout@v2
      with:
        path: phpBB3/phpBB/ext/${{ env.EXTNAME }}

    - name: Actions Setup - Copy to Temp Location
      run: php --version

    - name: Setup PHP
      uses: shivammathur/setup-php@v2
      with:
        php-version: ${{ env.PHP_VERSION }}
        extensions: >-
          dom, curl, libxml, mbstring, zip, pcntl, pdo, mysqli, sqlite,
          pdo_sqlite, intl, gd, exif, iconv, sqlsrv, pdo_sqlsrv, ldap
        coverage: none

    - name: Actions Setup - Composer Install/Remove/Require
      working-directory: phpBB3/phpBB
      run: |
        composer install --no-interaction --no-progress --no-suggest --ignore-platform-reqs
        composer remove sami/sami --no-interaction --no-progress --ignore-platform-reqs --dev
        # composer require phpbb/epv:dev-master --no-interaction --no-progress --no-suggest --ignore-platform-reqs --dev

    - name: Actions Test - Code Sniffer
      if: ${{ env.SNIFF != 0 }}
      env:
        NOTESTS: '1'
      working-directory: phpBB3
      run: .github/ext-sniff.sh "$EXTNAME" "$NOTESTS"

    - name: Actions Test - Code Sniffer
      working-directory: phpBB3
      run: >-
        phpBB/vendor/bin/phpcs -s --extensions=php --standard=build/code_sniffer/ruleset-php-extensions.xml
        "--ignore=*/$EXTNAME/tests/*,*/$EXTNAME/vendor/*" "phpBB/ext/$EXTNAME"

    - name: Setup EPV
      if: ${{ env.EPV != 0 }}
      working-directory: phpBB3/phpBB
      run: composer require phpbb/epv:dev-master --dev --no-interaction --ignore-platform-reqs

    - name: Actions Test - EPV (Extension Pre Validator)
      if: ${{ env.EPV != 0 }}
      working-directory: phpBB3
      run: phpBB/vendor/bin/EPV.php run --dir="phpBB/ext/$EXTNAME/"
